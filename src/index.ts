import { app, BrowserWindow, Menu, nativeImage, Tray } from 'electron';
// This allows TypeScript to pick up the magic constants that's auto-generated by Forge's Webpack
// plugin that tells the Electron app where to look for the Webpack-bundled app code (depending on
// whether you're running in development or production).
declare const MAIN_WINDOW_WEBPACK_ENTRY: string;
declare const MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY: string;
import {updateElectronApp} from 'update-electron-app';

// Global tray instance
let tray: Tray | null = null;

// Flag to track if auto-update is in progress
let isQuitting = false;
let isAutoUpdateInProgress = false;
let mainWindow: BrowserWindow | null = null;

updateElectronApp({
  notifyUser: false,
  onNotifyUser: (info) => {
    isAutoUpdateInProgress = true;
    // Notify frontend about update
    if (mainWindow) {
      mainWindow.webContents.send('update:available', info);
    }
    // In case the app is minimized to system tray, we need to force quit for update
    app.quit();
  }
});

// Handle creating/removing shortcuts on Windows when installing/uninstalling.
if (require('electron-squirrel-startup')) {
  app.quit();
}

const createWindow = (): void => {
  // Create the browser window.
  mainWindow = new BrowserWindow({
    height: 600,
    width: 800,
    webPreferences: {
      preload: MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY,
    },
  });

  // and load the index.html of the app.
  mainWindow.loadURL(MAIN_WINDOW_WEBPACK_ENTRY);

  // Handle window close event - hide instead of closing completely
  mainWindow.on('close', (event) => {
    // If app.quit() was called explicitly (from tray menu) or auto-update is in progress, don't prevent the window from closing
    if (isQuitting || isAutoUpdateInProgress) return;
    
    // Otherwise prevent the window from closing by default
    event.preventDefault();
    
    if (mainWindow) {
      // Just hide the window instead of closing it
      mainWindow.hide();
      
      // Hide the app from the Dock on macOS when window is closed
      if (process.platform === 'darwin') {
        app.dock.hide();
      }
    }
  });
  
  // Handle actual window closed event if it occurs
  mainWindow.on('closed', () => {
    mainWindow = null;
  });

  // Open the DevTools.
  mainWindow.webContents.openDevTools();
};

// This method will be called when Electron has finished
// initialization and is ready to create browser windows.
// Some APIs can only be used after this event occurs.
app.on('ready', () => {
  createWindow();
  createTray();
});

// Quit when all windows are closed, except on macOS. There, it's common
// for applications and their menu bar to stay active until the user quits
// explicitly with Cmd + Q.
app.on('window-all-closed', () => {
  if (process.platform === 'darwin') {
    app.dock.hide();
  }
});

app.on('activate', () => {
  // On OS X it's common to re-create a window in the app when the
  // dock icon is clicked and there are no other windows open.
  if (BrowserWindow.getAllWindows().length === 0) {
    createWindow();
  }
});


// Override the default app.quit to set our isQuitting flag first
const originalQuit = app.quit;
app.quit = function(...args) {
  // Set the flag to allow the window to close
  isQuitting = true;
  // Call the original quit method
  return originalQuit.apply(this, args);
};

// In this file you can include the rest of your app's specific main process
// code. You can also put them in separate files and import them here.


function createTray(): Tray | null {
  try {
    // Create tray instance - if no icon is found, use a simple fallback
    const icon = nativeImage.createFromDataURL('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAA3GVYSWZNTQAqAAAACAAGARIAAwAAAAEAAQAAARoABQAAAAEAAABWARsABQAAAAEAAABeATEAAgAAAEMAAABmATsAAgAAAAcAAACqh2kABAAAAAEAAACyAAAAAAAAAGAAAAABAAAAYAAAAAFDYW52YSBkb2M9REFHaDN4MnVSdzggdXNlcj1VQUZkdXhRaHFSOCBicmFuZD1CQUZkdTdfX0xrMCB0ZW1wbGF0ZT0AAFl1a2kgRgAAAAOgAQADAAAAAQABAACgAgAEAAAAAQAAABagAwAEAAAAAQAAABYAAAAAtdBixAAAAAlwSFlzAAAOxAAADsQBlSsOGwAABnFpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIgogICAgICAgICAgICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgICAgICAgICAgIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgICAgICAgICAgeG1sbnM6QXR0cmliPSJodHRwOi8vbnMuYXR0cmlidXRpb24uY29tL2Fkcy8xLjAvIj4KICAgICAgICAgPHhtcDpDcmVhdG9yVG9vbD5DYW52YSBkb2M9REFHaDN4MnVSdzggdXNlcj1VQUZkdXhRaHFSOCBicmFuZD1CQUZkdTdfX0xrMCB0ZW1wbGF0ZT08L3htcDpDcmVhdG9yVG9vbD4KICAgICAgICAgPGRjOmNyZWF0b3I+CiAgICAgICAgICAgIDxyZGY6U2VxPgogICAgICAgICAgICAgICA8cmRmOmxpPll1a2kgRjwvcmRmOmxpPgogICAgICAgICAgICA8L3JkZjpTZXE+CiAgICAgICAgIDwvZGM6Y3JlYXRvcj4KICAgICAgICAgPGRjOnRpdGxlPgogICAgICAgICAgICA8cmRmOkFsdD4KICAgICAgICAgICAgICAgPHJkZjpsaSB4bWw6bGFuZz0ieC1kZWZhdWx0Ij7nlJjlhZogLSAzPC9yZGY6bGk+CiAgICAgICAgICAgIDwvcmRmOkFsdD4KICAgICAgICAgPC9kYzp0aXRsZT4KICAgICAgICAgPGV4aWY6UGl4ZWxYRGltZW5zaW9uPjIwMDwvZXhpZjpQaXhlbFhEaW1lbnNpb24+CiAgICAgICAgIDxleGlmOkNvbG9yU3BhY2U+MTwvZXhpZjpDb2xvclNwYWNlPgogICAgICAgICA8ZXhpZjpQaXhlbFlEaW1lbnNpb24+MjAwPC9leGlmOlBpeGVsWURpbWVuc2lvbj4KICAgICAgICAgPHRpZmY6WFJlc29sdXRpb24+OTY8L3RpZmY6WFJlc29sdXRpb24+CiAgICAgICAgIDx0aWZmOllSZXNvbHV0aW9uPjk2PC90aWZmOllSZXNvbHV0aW9uPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICAgICA8QXR0cmliOkFkcz4KICAgICAgICAgICAgPHJkZjpTZXE+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8QXR0cmliOlRvdWNoVHlwZT4yPC9BdHRyaWI6VG91Y2hUeXBlPgogICAgICAgICAgICAgICAgICA8QXR0cmliOkNyZWF0ZWQ+MjAyNS0wMy0yMjwvQXR0cmliOkNyZWF0ZWQ+CiAgICAgICAgICAgICAgICAgIDxBdHRyaWI6RXh0SWQ+MjRjZjQxMjQtYTEwNS00N2E0LWI4ZGItMzk2NDI1NjM0NTAyPC9BdHRyaWI6RXh0SWQ+CiAgICAgICAgICAgICAgICAgIDxBdHRyaWI6RmJJZD41MjUyNjU5MTQxNzk1ODA8L0F0dHJpYjpGYklkPgogICAgICAgICAgICAgICA8L3JkZjpsaT4KICAgICAgICAgICAgPC9yZGY6U2VxPgogICAgICAgICA8L0F0dHJpYjpBZHM+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgr9WXAaAAAEMklEQVQ4EbVVSWybVRD+/s1bamezk2ax2yZNFWiD2tCqCNEGISEgqioOlaqAOMABgRAXbpyo4Ia4IaFcygUKFCkFtYdCi5CihpZuQpEiSimLsrjxUhzvju3f/vnmJQ5JCtw6sq158958b97MN2MNoxMOHoDoDwBTQZr/Bayt29j8pP/ba7jdByxODpEc+VFCC9+l7KsWp76qgGc0TT6ibZANwAa3ajwRsjRs9RioUxeHaKmGTI0KAbbwkkiTTlWDzvViqY57tgODuhxpyBow7Qo0aGpIpmwkp8q00Mo1RlzweXTYtOTLDn7+rggsy5X8PuFGsNVU4OsjXwOWl/e4NEQTNsYOBvDMm53IF23UanWcuRTHZLQC8EkHghZe/DAM09TR5DNx4Uocn1/LoidkIlohiERIUcCiy/2SBng1/JWzMbCjFY8f2EYDsDU4g8m3ZpTT6+/14eWxfcp++fosPvt2AfBoK760NrAU3QRP8hUr1zHEiC6cXMKps78hnszDZsQHh3sAHw+EdDy8qx3ZnKQJGD99Gxc/zmB3u6V8BUOwRP5Jhay4U2IhEDbQH25CIplDaqmAh3Z1YmTYh51dHlimgehiGgF/J3o7PMCQiaL40LcBqqDkZ01W9lkhh5E6ihWTV+bV9rGRThwaDuFuPId8gfmmVCrkHYspkW5A5fLfO0+u5tdlGTh5PsoFMPpUPx4ZDOHSjZjiudicVTTBbRRNVJH7gFUBAxoMElMqf+N0HjO3Yujb3o6WZi/e/zKuLhRn06A7C1cVwm+SDcAaVwFSDnM20rkqdPXGAq5PLyq32YUlYDoFXbqBkspWgZka2snxxjNWdoSZO4+fcNGuIk3XEItX8cpLIbw2thv9jLI9XMf5ywkceTKCL87exv5DbTg2OgiLadrR7cXvpRSmPskCAy7VfSp4omsdR884CfbrtlYDJ45vx/i5eVxNVPHOsx0olWx2Wg0fXc3g+X4vvp4u4OlBL3rbLKQLNewd8KsLhvcEkUqX8cIHv/DJBlrINS1wZMKR8DM3y/jm1KNsXQuHX73GJ5bUc1UZIpZiSuSwF/u63Bjq82NooBUdIR9cpN+f82lMfB/FV3dK2OLWUCRZNDw34US4mGMaQMPFd/eircWrDhdKVdRp87gNNPs5L7wW3C4T5YqN+bs5/PBTEuOfJlkT5voxD/xBE7nVYaXp/AepMzERFmBOrL9W8fYb3djDiLwek8AOlpmOpcwyZheLmLqVxY9kCmyOpLCFnmEPunwGYsUaFjgrGoNIk78maT+bAL1uHcuM8N45Ti/hKNeKqjJclMKk7bfQ1WOh26ejVHXwB8fm8mrnNUAlhwpYlMYsbqYSZgQV0iRNR0KjiaPTQ4pJLaR9Y+w4BrgiPCBnGM8GWZsVKjX0zPBERlJCnalXEpOI1vcA7cJ5ETFvBhX739yJnjTInPIjAAAAAElFTkSuQmCC')
    
    tray = new Tray(icon);
    tray.setToolTip('MCP Router');
  } catch (error) {
    console.error('Failed to create tray with icon, using default:', error);
    // As a last resort, use a system standard icon
    tray = new Tray(app.getPath('exe'));
    tray.setToolTip('MCP Router');
  }
  
  // Add click handlers for tray
  if (process.platform === 'darwin') {
    // On macOS, single-click will show the context menu
    // and double-click opens the main window
    tray.on('double-click', () => {
      app.dock.show();
      
      const mainWindow = BrowserWindow.getAllWindows()[0];
      if (mainWindow) {
        if (mainWindow.isMinimized()) mainWindow.restore();
        mainWindow.show();
        mainWindow.focus();
      } else {
        createOrShowMainWindow();
      }
    });
    
    // Single-click shows context menu on macOS
    tray.on('click', (event) => {
      tray?.popUpContextMenu();
    });
  } else {
    // On Windows/Linux, right-click will show the context menu (default)
    // Left-click will also show the context menu instead of opening window
    tray.on('click', (event) => {
      tray?.popUpContextMenu();
    });
  }
  const contextMenu = Menu.buildFromTemplate([
    {
      label: 'MCP Router',
      click: () => {
        // Show the app in the Dock on macOS when clicked from context menu
        if (process.platform === 'darwin') {
          app.dock.show();
        }
        
        createOrShowMainWindow();
      }
    },
    { type: 'separator' as const },
    {
      label: 'Quit',
      click: () => {
        app.quit();
      }
    }
  ]);
  
  tray.setContextMenu(contextMenu);
  
  return tray;
}
/**
 * Helper function to create or show the main window
 */
function createOrShowMainWindow(): void {
  const mainWindow = BrowserWindow.getAllWindows()[0];
  if (mainWindow) {
    if (mainWindow.isMinimized()) mainWindow.restore();
    mainWindow.show();
    mainWindow.focus();
  }
}
